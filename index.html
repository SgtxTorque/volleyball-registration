<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Player Registration</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#0a0a0a',
            card: '#1a1a1a',
            border: '#333',
            gold: '#FFD700',
            success: '#34C759',
            warning: '#FF9500',
            danger: '#FF3B30',
            info: '#5AC8FA',
          }
        }
      }
    }
  </script>
  <style>
    input, select, textarea {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    input[type="checkbox"] {
      -webkit-appearance: none;
      appearance: none;
      background-color: #1a1a1a;
      border: 2px solid #555;
      border-radius: 4px;
      width: 22px;
      height: 22px;
      cursor: pointer;
      position: relative;
      flex-shrink: 0;
    }
    input[type="checkbox"]:checked {
      background-color: #FFD700;
      border-color: #FFD700;
    }
    input[type="checkbox"]:checked::after {
      content: '';
      position: absolute;
      left: 6px;
      top: 2px;
      width: 6px;
      height: 12px;
      border: solid #0a0a0a;
      border-width: 0 3px 3px 0;
      transform: rotate(45deg);
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }
    .step-dot.active { background-color: #FFD700; }
    .step-dot.completed { background-color: #34C759; }
    
    .sign-btn { transition: all 0.3s ease; }
    .sign-btn:active { transform: scale(0.98); }
    .signed-container { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .player-tab.active {
      background-color: #FFD700;
      color: #0a0a0a;
    }
    
    .player-card {
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .remove-player-btn {
      transition: all 0.2s ease;
    }
    .remove-player-btn:hover {
      background-color: #FF3B30;
    }
  </style>
</head>
<body class="bg-dark min-h-screen text-white">
  
  <!-- Loading State -->
  <div id="loading" class="min-h-screen flex items-center justify-center">
    <div class="text-center">
      <div class="w-12 h-12 border-4 border-gold border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-gray-400">Loading registration...</p>
    </div>
  </div>

  <!-- No Season State -->
  <div id="no-season" class="min-h-screen flex items-center justify-center p-4 hidden">
    <div class="text-center">
      <div class="text-6xl mb-4">&#9888;</div>
      <h1 class="text-2xl font-bold mb-2">Registration Closed</h1>
      <p class="text-gray-400">There are no seasons open for registration at this time.</p>
      <p class="text-gray-400 mt-2">Please contact your coach for more information.</p>
    </div>
  </div>

  <!-- Season Selector -->
  <div id="season-selector" class="min-h-screen flex items-center justify-center p-4 hidden">
    <div class="max-w-md w-full">
      <div class="text-center mb-8">
        <div class="w-16 h-16 bg-gold rounded-full flex items-center justify-center mx-auto mb-4">
          <span class="text-2xl font-bold text-dark">VB</span>
        </div>
        <h1 class="text-2xl font-bold">Black Hornets Volleyball</h1>
        <p class="text-gray-400 mt-2">Select a season to register for</p>
      </div>
      
      <div id="season-buttons" class="space-y-3">
        <!-- Season buttons will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Success State -->
  <div id="success" class="min-h-screen p-4 hidden">
    <div class="max-w-md mx-auto py-8">
      
      <!-- Success Header -->
      <div class="text-center mb-6">
        <div class="w-20 h-20 bg-success rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h1 class="text-2xl font-bold mb-2">Registration Complete!</h1>
        <p class="text-gray-400">Welcome to <span id="success-season-name">the team</span>!</p>
      </div>
      
      <!-- Registered Players Summary -->
      <div id="registered-players-summary" class="bg-card rounded-2xl p-6 mb-6">
        <h2 class="text-lg font-bold mb-4 text-gold">Players Registered</h2>
        <div id="registered-players-list" class="space-y-2">
          <!-- Will be populated dynamically -->
        </div>
      </div>
      
      <!-- Account Creation Section -->
      <div id="account-creation-section" class="bg-card rounded-2xl p-6 mb-6">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 bg-gold rounded-full flex items-center justify-center">
            <svg class="w-5 h-5 text-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
          </div>
          <div>
            <h2 class="text-lg font-bold">Create Your Account</h2>
            <p class="text-sm text-gray-400">Manage everything in the VolleyBrain app</p>
          </div>
        </div>
        
        <!-- Account Form -->
        <div id="account-form" class="space-y-4">
          <div>
            <label class="block text-sm text-gray-400 mb-2">Email</label>
            <input type="email" id="account_email" class="w-full bg-dark border border-border rounded-xl p-4 text-white" readonly>
          </div>
          
          <div>
            <label class="block text-sm text-gray-400 mb-2">Phone</label>
            <input type="tel" id="account_phone" class="w-full bg-dark border border-border rounded-xl p-4 text-white" readonly>
          </div>
          
          <div>
            <label class="block text-sm text-gray-400 mb-2">Create Password *</label>
            <input type="password" id="account_password" class="w-full bg-dark border border-border rounded-xl p-4 text-white" placeholder="Minimum 8 characters">
          </div>
          
          <div>
            <label class="block text-sm text-gray-400 mb-2">Confirm Password *</label>
            <input type="password" id="account_password_confirm" class="w-full bg-dark border border-border rounded-xl p-4 text-white" placeholder="Re-enter password">
          </div>
          
          <!-- Player Accounts Section -->
          <div id="player-accounts-section" class="border-t border-border pt-4 mt-4">
            <div class="flex items-start gap-3 mb-4">
              <input type="checkbox" id="create_player_accounts" class="mt-1" onchange="togglePlayerAccountOptions()">
              <div>
                <label for="create_player_accounts" class="font-medium cursor-pointer">Create accounts for my players</label>
                <p class="text-sm text-gray-400">Players can view schedules and team info (COPPA compliant)</p>
              </div>
            </div>
            
            <div id="player-account-options" class="hidden space-y-3 ml-8">
              <!-- Will be populated dynamically -->
            </div>
          </div>
          
          <button onclick="createAccount()" id="create-account-btn" class="w-full bg-gold text-dark font-bold py-4 rounded-xl mt-4">
            Create Account
          </button>
          
          <button onclick="skipAccountCreation()" class="w-full text-gray-400 text-sm py-2">
            Maybe Later
          </button>
        </div>
        
        <!-- Account Created State -->
        <div id="account-created" class="hidden">
          <div class="bg-success/20 border border-success/30 rounded-xl p-4 flex items-center gap-3">
            <div class="w-10 h-10 bg-success rounded-full flex items-center justify-center flex-shrink-0">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>
            <div>
              <p class="font-bold text-success">Account Created!</p>
              <p class="text-sm text-gray-400">Download the app to sign in</p>
            </div>
          </div>
          
          <div class="flex gap-3 mt-4">
            <a href="#" class="flex-1 bg-dark border border-border rounded-xl p-3 flex items-center justify-center gap-2">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
              </svg>
              <span class="text-sm">App Store</span>
            </a>
            <a href="#" class="flex-1 bg-dark border border-border rounded-xl p-3 flex items-center justify-center gap-2">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3.18 23.71c-.55-.31-.89-.89-.89-1.53V1.82c0-.64.34-1.22.89-1.53l11.06 11.71L3.18 23.71zm15.6-8.93l-3.38-3.59 3.38-3.59 3.83 2.15c.68.38.68 1.36 0 1.74l-3.83 2.15v1.14zm-4.76-3.59l-10.31 10.94 14.25-8.01-3.94-2.93zm0-1.38L10.08 6.88l-6.97-3.92 10.91 10.85z"/>
              </svg>
              <span class="text-sm">Google Play</span>
            </a>
          </div>
        </div>
      </div>
      
      <!-- Payment Info Section -->
      <div id="payment-section" class="bg-card rounded-2xl p-6 mb-6">
        <h2 class="text-lg font-bold mb-4 text-gold">Payment Information</h2>
        <div id="payment-breakdown" class="space-y-3 text-sm">
          <!-- Will be populated dynamically -->
        </div>
      </div>

      <div class="bg-card rounded-2xl p-6">
        <h2 class="text-lg font-bold mb-4">Payment Methods</h2>
        <div class="space-y-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center font-bold text-sm">V</div>
            <div>
              <p class="font-medium">Venmo</p>
              <p class="text-gold">@BlackHornetsVB</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center font-bold text-sm">Z</div>
            <div>
              <p class="font-medium">Zelle</p>
              <p class="text-gold">payments@blackhornets.com</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center font-bold text-sm">$</div>
            <div>
              <p class="font-medium">Cash App</p>
              <p class="text-gold">$BlackHornetsVB</p>
            </div>
          </div>
        </div>
        <p class="text-gray-400 text-sm mt-4">Please include player name(s) in payment memo.</p>
      </div>

      <p class="text-center text-gray-400 text-sm mt-6">Your coach will be in touch soon with next steps!</p>
      
      <button onclick="registerAnother()" class="w-full bg-card border border-border text-white font-bold py-4 rounded-xl mt-6">
        Register Another Player
      </button>
    </div>
  </div>

  <!-- Registration Form -->
  <div id="form-container" class="min-h-screen p-4 hidden">
    <div class="max-w-lg mx-auto">
      
      <!-- Header -->
      <div class="text-center py-6">
        <h1 class="text-2xl font-bold text-gold">Player Registration</h1>
        <p id="season-name" class="text-gray-400 mt-1">Loading...</p>
        <button onclick="backToSeasonSelect()" id="change-season-btn" class="text-sm text-blue-400 mt-2 hidden">Change Season</button>
      </div>

      <!-- Progress Steps -->
      <div class="flex justify-center gap-2 mb-8">
        <div class="step-dot w-3 h-3 rounded-full bg-border" data-step="1"></div>
        <div class="step-dot w-3 h-3 rounded-full bg-border" data-step="2"></div>
        <div class="step-dot w-3 h-3 rounded-full bg-border" data-step="3"></div>
        <div class="step-dot w-3 h-3 rounded-full bg-border" data-step="4"></div>
        <div class="step-dot w-3 h-3 rounded-full bg-border" data-step="5"></div>
      </div>

      <!-- Step 1: Players -->
      <div id="step-1" class="step-content">
        <div class="bg-card rounded-2xl p-6">
          <h2 class="text-lg font-bold mb-1">Player Information</h2>
          <p class="text-gray-400 text-sm mb-6">Step 1 of 5 &bull; Add all children you want to register</p>
          
          <div id="players-container" class="space-y-4">
            <!-- Player cards will be inserted here -->
          </div>
          
          <button onclick="addPlayer()" id="add-player-btn" class="w-full bg-dark border-2 border-dashed border-border text-gray-400 font-medium py-4 rounded-xl mt-4 flex items-center justify-center gap-2 hover:border-gold hover:text-gold transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Add Another Child
          </button>
        </div>
        
        <button onclick="nextStep(1)" class="w-full bg-gold text-dark font-bold py-4 rounded-xl mt-6">
          Continue
        </button>
      </div>

      <!-- Step 2: Parent/Guardian Info -->
      <div id="step-2" class="step-content hidden">
        <div class="bg-card rounded-2xl p-6">
          <h2 class="text-lg font-bold mb-1">Parent/Guardian Information</h2>
          <p class="text-gray-400 text-sm mb-6">Step 2 of 5 &bull; This applies to all players</p>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-2">Parent/Guardian Name *</label>
              <input type="text" id="parent_name" class="w-full bg-dark border border-border rounded-xl p-4 text-white" required>
            </div>
            
            <div>
              <label class="block text-sm text-gray-400 mb-2">Phone *</label>
              <input type="tel" id="parent_phone" class="w-full bg-dark border border-border rounded-xl p-4 text-white" placeholder="000-000-0000" oninput="formatPhone(this)" maxlength="12" required>
            </div>
            
            <div>
              <label class="block text-sm text-gray-400 mb-2">Email *</label>
              <input type="email" id="parent_email" class="w-full bg-dark border border-border rounded-xl p-4 text-white" required>
            </div>
            
            <div>
              <label class="block text-sm text-gray-400 mb-2">Street Address *</label>
              <input type="text" id="street" class="w-full bg-dark border border-border rounded-xl p-4 text-white" required>
            </div>
            
            <div class="grid grid-cols-3 gap-3">
              <div class="col-span-2">
                <label class="block text-sm text-gray-400 mb-2">City *</label>
                <input type="text" id="city" class="w-full bg-dark border border-border rounded-xl p-4 text-white" required>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-2">State *</label>
                <select id="state" class="w-full bg-dark border border-border rounded-xl p-4 text-white" required>
                  <option value="TX">TX</option>
                  <option value="OK">OK</option>
                  <option value="AR">AR</option>
                  <option value="LA">LA</option>
                  <option value="NM">NM</option>
                </select>
              </div>
            </div>
            
            <div class="w-32">
              <label class="block text-sm text-gray-400 mb-2">ZIP *</label>
              <input type="text" id="zip" class="w-full bg-dark border border-border rounded-xl p-4 text-white" maxlength="5" required>
            </div>
            
            <div class="border-t border-border pt-4 mt-4">
              <p class="text-sm text-gray-400 mb-4">Secondary Parent/Guardian (Optional)</p>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm text-gray-400 mb-2">Name</label>
                  <input type="text" id="parent_2_name" class="w-full bg-dark border border-border rounded-xl p-4 text-white">
                </div>
                <div>
                  <label class="block text-sm text-gray-400 mb-2">Phone</label>
                  <input type="tel" id="parent_2_phone" class="w-full bg-dark border border-border rounded-xl p-4 text-white" placeholder="000-000-0000" oninput="formatPhone(this)" maxlength="12">
                </div>
                <div>
                  <label class="block text-sm text-gray-400 mb-2">Email</label>
                  <input type="email" id="parent_2_email" class="w-full bg-dark border border-border rounded-xl p-4 text-white">
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="flex gap-4 mt-6">
          <button onclick="prevStep(2)" class="flex-1 bg-card text-white font-bold py-4 rounded-xl border border-border">
            Back
          </button>
          <button onclick="nextStep(2)" class="flex-1 bg-gold text-dark font-bold py-4 rounded-xl">
            Continue
          </button>
        </div>
      </div>

      <!-- Step 3: Emergency Contact -->
      <div id="step-3" class="step-content hidden">
        <div class="bg-card rounded-2xl p-6">
          <h2 class="text-lg font-bold mb-1">Emergency Contact</h2>
          <p class="text-gray-400 text-sm mb-6">Step 3 of 5 &bull; Contact other than parent/guardian</p>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-2">Contact Name *</label>
              <input type="text" id="emergency_contact_name" class="w-full bg-dark border border-border rounded-xl p-4 text-white" required>
            </div>
            
            <div>
              <label class="block text-sm text-gray-400 mb-2">Contact Phone *</label>
              <input type="tel" id="emergency_contact_phone" class="w-full bg-dark border border-border rounded-xl p-4 text-white" placeholder="000-000-0000" oninput="formatPhone(this)" maxlength="12" required>
            </div>
            
            <div>
              <label class="block text-sm text-gray-400 mb-2">Relationship *</label>
              <input type="text" id="emergency_contact_relation" class="w-full bg-dark border border-border rounded-xl p-4 text-white" placeholder="e.g., Grandparent, Aunt, Uncle" required>
            </div>
          </div>
        </div>
        
        <div class="flex gap-4 mt-6">
          <button onclick="prevStep(3)" class="flex-1 bg-card text-white font-bold py-4 rounded-xl border border-border">
            Back
          </button>
          <button onclick="nextStep(3)" class="flex-1 bg-gold text-dark font-bold py-4 rounded-xl">
            Continue
          </button>
        </div>
      </div>

      <!-- Step 4: Player Details (Medical, Volleyball, Uniform per player) -->
      <div id="step-4" class="step-content hidden">
        <div class="bg-card rounded-2xl p-6">
          <h2 class="text-lg font-bold mb-1">Player Details</h2>
          <p class="text-gray-400 text-sm mb-4">Step 4 of 5 &bull; Medical, volleyball & uniform info</p>
          
          <!-- Player Tabs -->
          <div id="player-tabs" class="flex gap-2 mb-6 overflow-x-auto pb-2">
            <!-- Tabs generated dynamically -->
          </div>
          
          <!-- Player Detail Sections -->
          <div id="player-details-container">
            <!-- Generated dynamically -->
          </div>
        </div>
        
        <div class="flex gap-4 mt-6">
          <button onclick="prevStep(4)" class="flex-1 bg-card text-white font-bold py-4 rounded-xl border border-border">
            Back
          </button>
          <button onclick="nextStep(4)" class="flex-1 bg-gold text-dark font-bold py-4 rounded-xl">
            Continue
          </button>
        </div>
      </div>

      <!-- Step 5: Waivers -->
      <div id="step-5" class="step-content hidden">
        <div class="bg-card rounded-2xl p-6">
          <h2 class="text-lg font-bold mb-1">Waivers & Agreement</h2>
          <p class="text-gray-400 text-sm mb-6">Step 5 of 5 &bull; Applies to all registered players</p>
          
          <!-- Players being registered summary -->
          <div class="bg-dark rounded-xl p-4 mb-6">
            <p class="text-sm text-gold mb-2">Registering:</p>
            <div id="waiver-players-list" class="space-y-1">
              <!-- Generated dynamically -->
            </div>
          </div>
          
          <div class="space-y-6">
            <div class="bg-dark rounded-xl p-4">
              <div class="flex items-start gap-3">
                <input type="checkbox" id="waiver_liability" class="mt-1 w-5 h-5 rounded" required>
                <div>
                  <label for="waiver_liability" class="font-medium">Liability Waiver *</label>
                  <p class="text-sm text-gray-400 mt-1">I understand that volleyball involves physical activity and risk of injury. I release the organization, coaches, and volunteers from liability for any injuries that may occur during practices, games, or events.</p>
                </div>
              </div>
            </div>
            
            <div class="bg-dark rounded-xl p-4">
              <div class="flex items-start gap-3">
                <input type="checkbox" id="waiver_photo" class="mt-1 w-5 h-5 rounded">
                <div>
                  <label for="waiver_photo" class="font-medium">Photo/Video Release</label>
                  <p class="text-sm text-gray-400 mt-1">I grant permission to photograph and/or video record my child(ren) for use in promotional materials, social media, and team communications.</p>
                </div>
              </div>
            </div>
            
            <div class="bg-dark rounded-xl p-4">
              <div class="flex items-start gap-3">
                <input type="checkbox" id="waiver_conduct" class="mt-1 w-5 h-5 rounded" required>
                <div>
                  <label for="waiver_conduct" class="font-medium">Code of Conduct *</label>
                  <p class="text-sm text-gray-400 mt-1">I agree that my child(ren) and our family will demonstrate good sportsmanship, respect coaches and officials, and follow all team rules and policies.</p>
                </div>
              </div>
            </div>
            
            <!-- TAP TO SIGN SECTION -->
            <div class="border-t border-border pt-6">
              <p class="text-sm text-gray-400 mb-4">Parent/Guardian Signature *</p>
              
              <!-- Unsigned State -->
              <div id="unsigned-container">
                <div class="bg-dark rounded-xl p-4 mb-4">
                  <p class="text-sm text-gray-300 leading-relaxed">
                    By signing below, I acknowledge that I have read and agree to all waivers above for all players listed. 
                    I certify that all information provided in this registration is accurate and complete to the best of my knowledge.
                  </p>
                </div>
                
                <button 
                  type="button"
                  onclick="tapToSign()" 
                  id="tap-to-sign-btn"
                  class="sign-btn w-full bg-gold text-dark font-bold py-5 rounded-xl flex items-center justify-center gap-3"
                >
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                  </svg>
                  <span id="sign-btn-text">Tap to Sign as "<span id="signer-name-preview">Parent Name</span>"</span>
                </button>
                <p class="text-xs text-gray-500 text-center mt-2">Your name will be pulled from the Parent/Guardian field</p>
              </div>
              
              <!-- Signed State (hidden initially) -->
              <div id="signed-container" class="hidden signed-container">
                <div class="bg-success/20 border-2 border-success rounded-xl p-5">
                  <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-success rounded-full flex items-center justify-center">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                      </svg>
                    </div>
                    <div>
                      <p class="font-bold text-success">Signed</p>
                      <p class="text-white font-medium" id="signed-name-display">John Smith</p>
                    </div>
                  </div>
                  <p class="text-sm text-gray-400" id="signed-timestamp">January 3, 2026 at 12:45 PM</p>
                </div>
                
                <button 
                  type="button"
                  onclick="clearSignature()" 
                  class="w-full text-gray-400 text-sm py-3 mt-2"
                >
                  Clear signature and sign again
                </button>
              </div>
              
              <!-- Hidden inputs for form data -->
              <input type="hidden" id="waiver_signed_by" value="">
              <input type="hidden" id="waiver_signed_date" value="">
            </div>
          </div>
        </div>
        
        <div class="flex gap-4 mt-6">
          <button onclick="prevStep(5)" class="flex-1 bg-card text-white font-bold py-4 rounded-xl border border-border">
            Back
          </button>
          <button onclick="submitRegistration()" id="submit-btn" class="flex-1 bg-success text-white font-bold py-4 rounded-xl">
            Complete Registration
          </button>
        </div>
      </div>

    </div>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    const SUPABASE_URL = 'https://uqpjvbiuokwpldjvxiby.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxcGp2Yml1b2t3cGxkanZ4aWJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMTEwODMsImV4cCI6MjA4Mjc4NzA4M30.k643d5gVS2uWWe_QgSvAMjWVuRgBIU2wI0bR38vYDCc';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let openSeasons = [];
    let selectedSeason = null;
    let currentStep = 1;
    let isSigned = false;
    
    // Multi-player support
    let players = [];
    let activePlayerIndex = 0;

    // Generate UUID for family_id
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // Phone formatter
    function formatPhone(input) {
      let value = input.value.replace(/\D/g, '');
      if (value.length > 10) value = value.substring(0, 10);
      if (value.length > 6) {
        value = value.substring(0, 3) + '-' + value.substring(3, 6) + '-' + value.substring(6);
      } else if (value.length > 3) {
        value = value.substring(0, 3) + '-' + value.substring(3);
      }
      input.value = value;
    }

    // Initialize with one player
    function initPlayers() {
      players = [{
        first_name: '',
        last_name: '',
        dob: '',
        grade: '',
        school: '',
        player_type: '',
        medical_conditions: '',
        allergies: '',
        medications: '',
        position: '',
        experience_level: '',
        experience_details: '',
        goals: '',
        jersey_pref_1: '',
        jersey_pref_2: '',
        jersey_pref_3: '',
        uniform_size_jersey: '',
        uniform_size_shorts: '',
      }];
      renderPlayerCards();
    }

    // Add a new player
    function addPlayer() {
      players.push({
        first_name: '',
        last_name: '',
        dob: '',
        grade: '',
        school: '',
        player_type: '',
        medical_conditions: '',
        allergies: '',
        medications: '',
        position: '',
        experience_level: '',
        experience_details: '',
        goals: '',
        jersey_pref_1: '',
        jersey_pref_2: '',
        jersey_pref_3: '',
        uniform_size_jersey: '',
        uniform_size_shorts: '',
      });
      renderPlayerCards();
      
      // Scroll to new player
      setTimeout(() => {
        const cards = document.querySelectorAll('.player-card');
        if (cards.length > 0) {
          cards[cards.length - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 100);
    }

    // Remove a player
    function removePlayer(index) {
      if (players.length <= 1) {
        alert('You must register at least one player.');
        return;
      }
      players.splice(index, 1);
      if (activePlayerIndex >= players.length) {
        activePlayerIndex = players.length - 1;
      }
      renderPlayerCards();
    }

    // Save player data from card inputs
    function savePlayerData(index) {
      const prefix = 'player_' + index + '_';
      const fields = ['first_name', 'last_name', 'dob', 'grade', 'school', 'player_type'];
      fields.forEach(field => {
        const el = document.getElementById(prefix + field);
        if (el) players[index][field] = el.value;
      });
    }

    // Save player details (step 4)
    function savePlayerDetails(index) {
      const prefix = 'pd_' + index + '_';
      const fields = [
        'medical_conditions', 'allergies', 'medications',
        'position', 'experience_level', 'experience_details', 'goals',
        'jersey_pref_1', 'jersey_pref_2', 'jersey_pref_3',
        'uniform_size_jersey', 'uniform_size_shorts'
      ];
      fields.forEach(field => {
        const el = document.getElementById(prefix + field);
        if (el) players[index][field] = el.value;
      });
    }

    // Render player cards for Step 1
    function renderPlayerCards() {
      const container = document.getElementById('players-container');
      container.innerHTML = '';
      
      players.forEach((player, index) => {
        const card = document.createElement('div');
        card.className = 'player-card bg-dark rounded-xl p-4 border border-border';
        card.innerHTML = `
          <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 bg-gold rounded-full flex items-center justify-center text-dark font-bold text-sm">
                ${index + 1}
              </div>
              <span class="font-medium">Player ${index + 1}</span>
              ${players.length > 1 ? '<span class="text-xs text-gray-500">(Sibling)</span>' : ''}
            </div>
            ${players.length > 1 ? `
              <button onclick="removePlayer(${index})" class="remove-player-btn w-8 h-8 rounded-full bg-dark border border-border flex items-center justify-center text-gray-400 hover:text-white">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            ` : ''}
          </div>
          
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs text-gray-400 mb-1">First Name *</label>
                <input type="text" id="player_${index}_first_name" value="${player.first_name}" 
                  onchange="savePlayerData(${index})"
                  class="w-full bg-card border border-border rounded-lg p-3 text-white text-sm" required>
              </div>
              <div>
                <label class="block text-xs text-gray-400 mb-1">Last Name *</label>
                <input type="text" id="player_${index}_last_name" value="${player.last_name}"
                  onchange="savePlayerData(${index})"
                  class="w-full bg-card border border-border rounded-lg p-3 text-white text-sm" required>
              </div>
            </div>
            
            <div>
              <label class="block text-xs text-gray-400 mb-1">Date of Birth *</label>
              <input type="date" id="player_${index}_dob" value="${player.dob}"
                onchange="savePlayerData(${index})"
                class="w-full bg-card border border-border rounded-lg p-3 text-white text-sm" required>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs text-gray-400 mb-1">Grade (Fall 2025) *</label>
                <select id="player_${index}_grade" onchange="savePlayerData(${index})"
                  class="w-full bg-card border border-border rounded-lg p-3 text-white text-sm" required>
                  <option value="">Select</option>
                  <option value="5" ${player.grade === '5' ? 'selected' : ''}>5th Grade</option>
                  <option value="6" ${player.grade === '6' ? 'selected' : ''}>6th Grade</option>
                  <option value="7" ${player.grade === '7' ? 'selected' : ''}>7th Grade</option>
                  <option value="8" ${player.grade === '8' ? 'selected' : ''}>8th Grade</option>
                </select>
              </div>
              <div>
                <label class="block text-xs text-gray-400 mb-1">Player Type *</label>
                <select id="player_${index}_player_type" onchange="savePlayerData(${index})"
                  class="w-full bg-card border border-border rounded-lg p-3 text-white text-sm" required>
                  <option value="">Select</option>
                  <option value="new" ${player.player_type === 'new' ? 'selected' : ''}>New Player</option>
                  <option value="returning" ${player.player_type === 'returning' ? 'selected' : ''}>Returning</option>
                </select>
              </div>
            </div>
            
            <div>
              <label class="block text-xs text-gray-400 mb-1">School *</label>
              <input type="text" id="player_${index}_school" value="${player.school}"
                onchange="savePlayerData(${index})"
                class="w-full bg-card border border-border rounded-lg p-3 text-white text-sm" required>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
      
      // Update add button text
      const addBtn = document.getElementById('add-player-btn');
      if (players.length >= 5) {
        addBtn.style.display = 'none';
      } else {
        addBtn.style.display = 'flex';
      }
    }

    // Render player tabs for Step 4
    function renderPlayerTabs() {
      const tabsContainer = document.getElementById('player-tabs');
      tabsContainer.innerHTML = '';
      
      players.forEach((player, index) => {
        const tab = document.createElement('button');
        tab.className = `player-tab px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap ${index === activePlayerIndex ? 'active' : 'bg-dark text-gray-400'}`;
        tab.textContent = player.first_name || 'Player ' + (index + 1);
        tab.onclick = () => switchPlayerTab(index);
        tabsContainer.appendChild(tab);
      });
    }

    // Switch active player tab in Step 4
    function switchPlayerTab(index) {
      // Save current player's details before switching
      savePlayerDetails(activePlayerIndex);
      
      activePlayerIndex = index;
      renderPlayerTabs();
      renderPlayerDetailsForm();
    }

    // Render player details form for Step 4
    function renderPlayerDetailsForm() {
      const container = document.getElementById('player-details-container');
      const player = players[activePlayerIndex];
      const prefix = 'pd_' + activePlayerIndex + '_';
      
      // Check if player has any medical info already
      const hasMedicalInfo = player.medical_conditions || player.allergies || player.medications;
      
      container.innerHTML = `
        <div class="space-y-6">
          <!-- Medical Section -->
          <div>
            <p class="text-sm text-gold mb-4">Medical Information for ${player.first_name || 'Player ' + (activePlayerIndex + 1)}</p>
            
            <!-- Medical Toggle -->
            <div class="bg-dark rounded-xl p-4">
              <label class="flex items-start gap-3 cursor-pointer">
                <input type="checkbox" id="${prefix}has_medical" 
                  class="mt-1 w-5 h-5 rounded" 
                  onchange="toggleMedicalFields(${activePlayerIndex})"
                  ${hasMedicalInfo ? 'checked' : ''}>
                <div>
                  <span class="font-medium">Does this player have any medical conditions, allergies, or medications we should know about?</span>
                  <p class="text-sm text-gray-500 mt-1">Check this box to report health information</p>
                </div>
              </label>
            </div>
            
            <!-- Medical Fields (hidden by default) -->
            <div id="${prefix}medical_fields" class="${hasMedicalInfo ? '' : 'hidden'} mt-4">
              <div class="bg-info/10 border border-info/30 rounded-lg p-3 mb-4 flex items-start gap-2">
                <svg class="w-5 h-5 text-info flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-sm text-info">Only fill in what applies - leave other fields blank</p>
              </div>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm text-gray-400 mb-2">Medical Conditions</label>
                  <textarea id="${prefix}medical_conditions" 
                    class="w-full bg-dark border border-border rounded-xl p-4 text-white h-20" 
                    placeholder="e.g., Asthma, Diabetes">${player.medical_conditions}</textarea>
                </div>
                <div>
                  <label class="block text-sm text-gray-400 mb-2">Allergies</label>
                  <textarea id="${prefix}allergies" 
                    class="w-full bg-dark border border-border rounded-xl p-4 text-white h-20" 
                    placeholder="e.g., Peanuts, Bee stings">${player.allergies}</textarea>
                </div>
                <div>
                  <label class="block text-sm text-gray-400 mb-2">Current Medications</label>
                  <textarea id="${prefix}medications" 
                    class="w-full bg-dark border border-border rounded-xl p-4 text-white h-20" 
                    placeholder="e.g., Inhaler, EpiPen">${player.medications}</textarea>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Volleyball Section -->
          <div class="border-t border-border pt-6">
            <p class="text-sm text-gold mb-4">Volleyball Experience</p>
            <div class="space-y-4">
              <div>
                <label class="block text-sm text-gray-400 mb-2">Preferred Position</label>
                <select id="${prefix}position" class="w-full bg-dark border border-border rounded-xl p-4 text-white">
                  <option value="">No Preference</option>
                  <option value="OH" ${player.position === 'OH' ? 'selected' : ''}>Outside Hitter (OH)</option>
                  <option value="S" ${player.position === 'S' ? 'selected' : ''}>Setter (S)</option>
                  <option value="MB" ${player.position === 'MB' ? 'selected' : ''}>Middle Blocker (MB)</option>
                  <option value="OPP" ${player.position === 'OPP' ? 'selected' : ''}>Opposite (OPP)</option>
                  <option value="L" ${player.position === 'L' ? 'selected' : ''}>Libero (L)</option>
                  <option value="DS" ${player.position === 'DS' ? 'selected' : ''}>Defensive Specialist (DS)</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm text-gray-400 mb-2">Experience Level *</label>
                <select id="${prefix}experience_level" class="w-full bg-dark border border-border rounded-xl p-4 text-white" required>
                  <option value="">Select Level</option>
                  <option value="none" ${player.experience_level === 'none' ? 'selected' : ''}>No Experience</option>
                  <option value="beginner" ${player.experience_level === 'beginner' ? 'selected' : ''}>Beginner (less than 1 year)</option>
                  <option value="intermediate" ${player.experience_level === 'intermediate' ? 'selected' : ''}>Intermediate (1-2 years)</option>
                  <option value="advanced" ${player.experience_level === 'advanced' ? 'selected' : ''}>Advanced (3+ years)</option>
                  <option value="club" ${player.experience_level === 'club' ? 'selected' : ''}>Club Experience</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm text-gray-400 mb-2">Experience Details</label>
                <textarea id="${prefix}experience_details" 
                  class="w-full bg-dark border border-border rounded-xl p-4 text-white h-20" 
                  placeholder="Previous teams, camps, training...">${player.experience_details}</textarea>
              </div>
              
              <div>
                <label class="block text-sm text-gray-400 mb-2">Goals for This Season</label>
                <textarea id="${prefix}goals" 
                  class="w-full bg-dark border border-border rounded-xl p-4 text-white h-20" 
                  placeholder="What do you hope to achieve?">${player.goals}</textarea>
              </div>
            </div>
          </div>
          
          <!-- Jersey Preferences -->
          <div class="border-t border-border pt-6">
            <p class="text-sm text-gold mb-4">Jersey Preferences</p>
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label class="block text-sm text-gray-400 mb-2">1st Choice</label>
                <input type="number" id="${prefix}jersey_pref_1" value="${player.jersey_pref_1}"
                  class="w-full bg-dark border border-border rounded-xl p-4 text-white" min="0" max="99" placeholder="#">
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-2">2nd Choice</label>
                <input type="number" id="${prefix}jersey_pref_2" value="${player.jersey_pref_2}"
                  class="w-full bg-dark border border-border rounded-xl p-4 text-white" min="0" max="99" placeholder="#">
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-2">3rd Choice</label>
                <input type="number" id="${prefix}jersey_pref_3" value="${player.jersey_pref_3}"
                  class="w-full bg-dark border border-border rounded-xl p-4 text-white" min="0" max="99" placeholder="#">
              </div>
            </div>
          </div>
          
          <!-- Uniform Sizes -->
          <div class="border-t border-border pt-6">
            <p class="text-sm text-gold mb-4">Uniform Sizes</p>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-gray-400 mb-2">Jersey Size *</label>
                <select id="${prefix}uniform_size_jersey" class="w-full bg-dark border border-border rounded-xl p-4 text-white" required>
                  <option value="">Select Size</option>
                  <option value="YS" ${player.uniform_size_jersey === 'YS' ? 'selected' : ''}>Youth Small</option>
                  <option value="YM" ${player.uniform_size_jersey === 'YM' ? 'selected' : ''}>Youth Medium</option>
                  <option value="YL" ${player.uniform_size_jersey === 'YL' ? 'selected' : ''}>Youth Large</option>
                  <option value="AS" ${player.uniform_size_jersey === 'AS' ? 'selected' : ''}>Adult Small</option>
                  <option value="AM" ${player.uniform_size_jersey === 'AM' ? 'selected' : ''}>Adult Medium</option>
                  <option value="AL" ${player.uniform_size_jersey === 'AL' ? 'selected' : ''}>Adult Large</option>
                  <option value="AXL" ${player.uniform_size_jersey === 'AXL' ? 'selected' : ''}>Adult XL</option>
                </select>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-2">Shorts Size *</label>
                <select id="${prefix}uniform_size_shorts" class="w-full bg-dark border border-border rounded-xl p-4 text-white" required>
                  <option value="">Select Size</option>
                  <option value="YS" ${player.uniform_size_shorts === 'YS' ? 'selected' : ''}>Youth Small</option>
                  <option value="YM" ${player.uniform_size_shorts === 'YM' ? 'selected' : ''}>Youth Medium</option>
                  <option value="YL" ${player.uniform_size_shorts === 'YL' ? 'selected' : ''}>Youth Large</option>
                  <option value="AS" ${player.uniform_size_shorts === 'AS' ? 'selected' : ''}>Adult Small</option>
                  <option value="AM" ${player.uniform_size_shorts === 'AM' ? 'selected' : ''}>Adult Medium</option>
                  <option value="AL" ${player.uniform_size_shorts === 'AL' ? 'selected' : ''}>Adult Large</option>
                  <option value="AXL" ${player.uniform_size_shorts === 'AXL' ? 'selected' : ''}>Adult XL</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        ${players.length > 1 ? `
          <div class="flex justify-between mt-6 pt-4 border-t border-border">
            <button onclick="prevPlayerTab()" class="text-gray-400 text-sm ${activePlayerIndex === 0 ? 'invisible' : ''}">
              &larr; Previous Player
            </button>
            <button onclick="nextPlayerTab()" class="text-gold text-sm ${activePlayerIndex === players.length - 1 ? 'invisible' : ''}">
              Next Player &rarr;
            </button>
          </div>
        ` : ''}
      `;
    }

    function prevPlayerTab() {
      if (activePlayerIndex > 0) {
        switchPlayerTab(activePlayerIndex - 1);
      }
    }

    function nextPlayerTab() {
      if (activePlayerIndex < players.length - 1) {
        switchPlayerTab(activePlayerIndex + 1);
      }
    }

    // Toggle medical fields visibility
    function toggleMedicalFields(index) {
      const prefix = 'pd_' + index + '_';
      const checkbox = document.getElementById(prefix + 'has_medical');
      const fieldsContainer = document.getElementById(prefix + 'medical_fields');
      
      if (checkbox.checked) {
        fieldsContainer.classList.remove('hidden');
      } else {
        fieldsContainer.classList.add('hidden');
        // Clear the fields when unchecked
        document.getElementById(prefix + 'medical_conditions').value = '';
        document.getElementById(prefix + 'allergies').value = '';
        document.getElementById(prefix + 'medications').value = '';
        // Also clear from player data
        players[index].medical_conditions = '';
        players[index].allergies = '';
        players[index].medications = '';
      }
    }

    // Update waiver players list
    function updateWaiverPlayersList() {
      const container = document.getElementById('waiver-players-list');
      container.innerHTML = players.map(p => 
        `<p class="text-white">&bull; ${p.first_name} ${p.last_name}</p>`
      ).join('');
    }

    // Update signer name preview when entering step 5
    function updateSignerNamePreview() {
      const parentName = document.getElementById('parent_name').value.trim() || 'Parent Name';
      document.getElementById('signer-name-preview').textContent = parentName;
    }

    // Tap to Sign function
    function tapToSign() {
      const parentName = document.getElementById('parent_name').value.trim();
      
      if (!parentName) {
        alert('Please go back and enter the Parent/Guardian Name first.');
        return;
      }
      
      if (!document.getElementById('waiver_liability').checked || !document.getElementById('waiver_conduct').checked) {
        alert('Please check all required waivers before signing.');
        return;
      }
      
      const now = new Date();
      const formattedDate = now.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      }) + ' at ' + now.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
      });
      
      document.getElementById('waiver_signed_by').value = parentName;
      document.getElementById('waiver_signed_date').value = now.toISOString();
      document.getElementById('signed-name-display').textContent = parentName;
      document.getElementById('signed-timestamp').textContent = formattedDate;
      
      document.getElementById('unsigned-container').classList.add('hidden');
      document.getElementById('signed-container').classList.remove('hidden');
      
      isSigned = true;
    }

    // Clear signature
    function clearSignature() {
      document.getElementById('waiver_signed_by').value = '';
      document.getElementById('waiver_signed_date').value = '';
      document.getElementById('signed-container').classList.add('hidden');
      document.getElementById('unsigned-container').classList.remove('hidden');
      isSigned = false;
    }

    async function init() {
      try {
        const { data: seasons, error } = await db
          .from('seasons')
          .select('*')
          .eq('registration_open', true)
          .order('created_at', { ascending: false });

        if (error) throw error;

        openSeasons = seasons || [];

        document.getElementById('loading').classList.add('hidden');

        if (openSeasons.length === 0) {
          document.getElementById('no-season').classList.remove('hidden');
        } else if (openSeasons.length === 1) {
          selectSeason(openSeasons[0]);
        } else {
          showSeasonSelector();
        }

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('loading').innerHTML = '<div class="text-center"><p class="text-red-500">Failed to load registration.</p><p class="text-gray-400 mt-2">' + error.message + '</p></div>';
      }
    }

    function showSeasonSelector() {
      const container = document.getElementById('season-buttons');
      container.innerHTML = '';
      
      openSeasons.forEach(season => {
        const statusLabel = season.status === 'active' ? 'In Progress' : 
                          season.status === 'upcoming' ? 'Upcoming' : 'Completed';
        const statusColor = season.status === 'active' ? 'bg-green-500' : 
                          season.status === 'upcoming' ? 'bg-blue-500' : 'bg-gray-500';
        
        const btn = document.createElement('button');
        btn.className = 'w-full bg-card border border-border rounded-xl p-4 text-left hover:border-gold transition-colors';
        btn.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <p class="font-bold text-lg">${season.name}</p>
              <span class="inline-block ${statusColor} text-white text-xs px-2 py-1 rounded mt-1">${statusLabel}</span>
            </div>
            <svg class="w-6 h-6 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        `;
        btn.onclick = () => selectSeason(season);
        container.appendChild(btn);
      });
      
      document.getElementById('season-selector').classList.remove('hidden');
    }

    function selectSeason(season) {
      selectedSeason = season;
      document.getElementById('season-name').textContent = season.name;
      document.getElementById('success-season-name').textContent = season.name;
      
      if (openSeasons.length > 1) {
        document.getElementById('change-season-btn').classList.remove('hidden');
      }
      
      document.getElementById('season-selector').classList.add('hidden');
      document.getElementById('form-container').classList.remove('hidden');
      
      initPlayers();
      updateStepDots();
    }

    function backToSeasonSelect() {
      document.getElementById('form-container').classList.add('hidden');
      showSeasonSelector();
      resetForm();
    }

    function registerAnother() {
      document.getElementById('success').classList.add('hidden');
      resetForm();
      
      if (openSeasons.length > 1) {
        showSeasonSelector();
      } else {
        document.getElementById('form-container').classList.remove('hidden');
        initPlayers();
        updateStepDots();
      }
    }

    function resetForm() {
      currentStep = 1;
      isSigned = false;
      activePlayerIndex = 0;
      players = [];
      
      // Reset all form inputs
      document.querySelectorAll('#step-2 input, #step-2 select, #step-3 input, #step-5 input[type="checkbox"]').forEach(el => {
        if (el.type === 'checkbox') {
          el.checked = false;
        } else if (el.tagName === 'SELECT') {
          el.selectedIndex = 0;
        } else {
          el.value = '';
        }
      });
      document.getElementById('state').value = 'TX';
      
      // Reset signature UI
      document.getElementById('signed-container').classList.add('hidden');
      document.getElementById('unsigned-container').classList.remove('hidden');
      document.getElementById('signer-name-preview').textContent = 'Parent Name';
      
      // Reset step visibility
      for (let i = 1; i <= 5; i++) {
        document.getElementById('step-' + i).classList.add('hidden');
      }
      document.getElementById('step-1').classList.remove('hidden');
      updateStepDots();
    }

    function updateStepDots() {
      document.querySelectorAll('.step-dot').forEach(dot => {
        const step = parseInt(dot.dataset.step);
        dot.classList.remove('active', 'completed');
        if (step === currentStep) {
          dot.classList.add('active');
        } else if (step < currentStep) {
          dot.classList.add('completed');
        }
      });
    }

    function validateStep(step) {
      if (step === 1) {
        // Save all player data first
        players.forEach((_, index) => savePlayerData(index));
        
        // Validate each player
        for (let i = 0; i < players.length; i++) {
          const p = players[i];
          if (!p.first_name || !p.last_name || !p.dob || !p.grade || !p.school || !p.player_type) {
            alert(`Please complete all required fields for Player ${i + 1}.`);
            return false;
          }
        }
        return true;
      }
      
      if (step === 2) {
        const fields = ['parent_name', 'parent_phone', 'parent_email', 'street', 'city', 'state', 'zip'];
        for (const fieldId of fields) {
          const el = document.getElementById(fieldId);
          if (!el.value.trim()) {
            alert('Please complete all required fields.');
            el.focus();
            return false;
          }
        }
        return true;
      }
      
      if (step === 3) {
        const fields = ['emergency_contact_name', 'emergency_contact_phone', 'emergency_contact_relation'];
        for (const fieldId of fields) {
          const el = document.getElementById(fieldId);
          if (!el.value.trim()) {
            alert('Please complete all required fields.');
            el.focus();
            return false;
          }
        }
        return true;
      }
      
      if (step === 4) {
        // Save current player details
        savePlayerDetails(activePlayerIndex);
        
        // Validate each player's required fields
        for (let i = 0; i < players.length; i++) {
          const p = players[i];
          if (!p.experience_level || !p.uniform_size_jersey || !p.uniform_size_shorts) {
            alert(`Please complete experience level and uniform sizes for ${p.first_name || 'Player ' + (i + 1)}.`);
            switchPlayerTab(i);
            return false;
          }
        }
        return true;
      }
      
      if (step === 5) {
        if (!document.getElementById('waiver_liability').checked || !document.getElementById('waiver_conduct').checked) {
          alert('Please check all required waivers.');
          return false;
        }
        if (!isSigned) {
          alert('Please tap to sign the agreement before submitting.');
          return false;
        }
        return true;
      }
      
      return true;
    }

    function nextStep(step) {
      if (!validateStep(step)) return;
      
      document.getElementById('step-' + step).classList.add('hidden');
      document.getElementById('step-' + (step + 1)).classList.remove('hidden');
      currentStep = step + 1;
      updateStepDots();
      window.scrollTo(0, 0);
      
      // Setup step 4 - player details
      if (currentStep === 4) {
        activePlayerIndex = 0;
        renderPlayerTabs();
        renderPlayerDetailsForm();
      }
      
      // Setup step 5 - waivers
      if (currentStep === 5) {
        updateWaiverPlayersList();
        updateSignerNamePreview();
      }
    }

    function prevStep(step) {
      // Save player details if coming from step 4
      if (step === 4) {
        savePlayerDetails(activePlayerIndex);
      }
      
      document.getElementById('step-' + step).classList.add('hidden');
      document.getElementById('step-' + (step - 1)).classList.remove('hidden');
      currentStep = step - 1;
      updateStepDots();
      window.scrollTo(0, 0);
    }

    function getFullAddress() {
      const street = document.getElementById('street').value.trim();
      const city = document.getElementById('city').value.trim();
      const state = document.getElementById('state').value;
      const zip = document.getElementById('zip').value.trim();
      return [street, city, state, zip].filter(Boolean).join(', ');
    }

    async function submitRegistration() {
      if (!validateStep(5)) return;

      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.textContent = 'Submitting...';

      try {
        // Shared contact data
        const contactData = {
          primary_contact_name: document.getElementById('parent_name').value.trim(),
          primary_contact_phone: document.getElementById('parent_phone').value.trim(),
          primary_contact_email: document.getElementById('parent_email').value.trim(),
          secondary_contact_name: document.getElementById('parent_2_name').value.trim() || null,
          secondary_contact_phone: document.getElementById('parent_2_phone').value.trim() || null,
          secondary_contact_email: document.getElementById('parent_2_email').value.trim() || null,
          address: getFullAddress(),
          emergency_contact_name: document.getElementById('emergency_contact_name').value.trim(),
          emergency_contact_phone: document.getElementById('emergency_contact_phone').value.trim(),
          emergency_contact_relation: document.getElementById('emergency_contact_relation').value.trim(),
        };

        // Always create a family record (even for single player - cleaner data model)
        const { data: familyData, error: familyError } = await db
          .from('families')
          .insert(contactData)
          .select()
          .single();

        if (familyError) throw familyError;

        const familyId = familyData.id;

        // Shared data for all players
        const sharedData = {
          season_id: selectedSeason.id,
          family_id: familyId,
          parent_name: contactData.primary_contact_name,
          parent_phone: contactData.primary_contact_phone,
          parent_email: contactData.primary_contact_email,
          address: contactData.address,
          parent_2_name: contactData.secondary_contact_name,
          parent_2_phone: contactData.secondary_contact_phone,
          parent_2_email: contactData.secondary_contact_email,
          emergency_contact_name: contactData.emergency_contact_name,
          emergency_contact_phone: contactData.emergency_contact_phone,
          emergency_contact_relation: contactData.emergency_contact_relation,
          waiver_liability: document.getElementById('waiver_liability').checked,
          waiver_photo: document.getElementById('waiver_photo').checked,
          waiver_conduct: document.getElementById('waiver_conduct').checked,
          waiver_signed_by: document.getElementById('waiver_signed_by').value,
          waiver_signed_date: document.getElementById('waiver_signed_date').value,
          registration_source: 'web',
          registration_date: new Date().toISOString(),
        };

        const createdPlayers = [];
        
        // Create each player
        for (const player of players) {
          const playerData = {
            ...sharedData,
            first_name: player.first_name,
            last_name: player.last_name,
            dob: player.dob,
            grade: parseInt(player.grade),
            school: player.school,
            player_type: player.player_type,
            status: 'new',
            medical_conditions: player.medical_conditions || null,
            allergies: player.allergies || null,
            medications: player.medications || null,
            position: player.position || null,
            experience_level: player.experience_level,
            experience_details: player.experience_details || null,
            goals: player.goals || null,
            jersey_pref_1: player.jersey_pref_1 ? parseInt(player.jersey_pref_1) : null,
            jersey_pref_2: player.jersey_pref_2 ? parseInt(player.jersey_pref_2) : null,
            jersey_pref_3: player.jersey_pref_3 ? parseInt(player.jersey_pref_3) : null,
            uniform_size_jersey: player.uniform_size_jersey,
            uniform_size_shorts: player.uniform_size_shorts,
          };

          const { data: createdPlayer, error: playerError } = await db
            .from('players')
            .insert(playerData)
            .select()
            .single();

          if (playerError) throw playerError;
          
          createdPlayers.push(createdPlayer);

          // Create payments for this player
          const payments = [
            { season_id: selectedSeason.id, player_id: createdPlayer.id, fee_type: 'registration', amount: selectedSeason.fee_registration || 150, paid: false },
            { season_id: selectedSeason.id, player_id: createdPlayer.id, fee_type: 'uniform', amount: selectedSeason.fee_uniform || 35, paid: false },
            { season_id: selectedSeason.id, player_id: createdPlayer.id, fee_type: 'monthly_1', amount: selectedSeason.fee_monthly || 50, paid: false },
            { season_id: selectedSeason.id, player_id: createdPlayer.id, fee_type: 'monthly_2', amount: selectedSeason.fee_monthly || 50, paid: false },
            { season_id: selectedSeason.id, player_id: createdPlayer.id, fee_type: 'monthly_3', amount: selectedSeason.fee_monthly || 50, paid: false },
          ];

          const { error: paymentsError } = await db.from('payments').insert(payments);
          if (paymentsError) throw paymentsError;

          // Create registration record
          const regData = {
            player_id: createdPlayer.id,
            season_id: selectedSeason.id,
            family_id: familyId,
            status: 'new',
            submitted_at: new Date().toISOString(),
            needs_evaluation: player.player_type === 'new',
            registration_source: 'web',
          };

          const { error: regError } = await db.from('registrations').insert(regData);
          if (regError) console.warn('Registration record error:', regError); // Non-fatal
        }

        // Show success
        showSuccessScreen(createdPlayers);

      } catch (error) {
        console.error('Error:', error);
        alert('Registration failed: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Complete Registration';
      }
    }

    function showSuccessScreen(createdPlayers) {
      // Store for account creation
      window.registeredPlayers = createdPlayers;
      window.registrationEmail = document.getElementById('parent_email').value.trim();
      window.registrationPhone = document.getElementById('parent_phone').value.trim();
      window.registrationFamilyId = createdPlayers[0]?.family_id;
      
      // Update registered players list
      const playersList = document.getElementById('registered-players-list');
      playersList.innerHTML = createdPlayers.map(p => `
        <div class="flex items-center gap-3 bg-dark p-3 rounded-lg">
          <div class="w-8 h-8 bg-success rounded-full flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <div>
            <p class="font-medium">${p.first_name} ${p.last_name}</p>
            <p class="text-sm text-gray-400">Grade ${p.grade} &bull; ${p.player_type === 'returning' ? 'Returning' : 'New'}</p>
          </div>
        </div>
      `).join('');

      // Pre-fill account creation fields
      document.getElementById('account_email').value = window.registrationEmail;
      document.getElementById('account_phone').value = window.registrationPhone;
      
      // Populate player account options
      const playerAccountOptions = document.getElementById('player-account-options');
      playerAccountOptions.innerHTML = createdPlayers.map((p, i) => `
        <div class="bg-dark rounded-lg p-3">
          <div class="flex items-center gap-3 mb-2">
            <input type="checkbox" id="player_account_${i}" data-player-id="${p.id}" class="player-account-checkbox" checked>
            <label for="player_account_${i}" class="font-medium cursor-pointer">${p.first_name} ${p.last_name}</label>
          </div>
          <div class="ml-7">
            <label class="block text-xs text-gray-400 mb-1">PIN (4 digits)</label>
            <input type="password" id="player_pin_${i}" maxlength="4" pattern="[0-9]{4}" 
              class="w-24 bg-card border border-border rounded-lg p-2 text-white text-center tracking-widest"
              placeholder="****" inputmode="numeric">
          </div>
        </div>
      `).join('');

      // Update payment breakdown
      const feeReg = selectedSeason.fee_registration || 150;
      const feeUniform = selectedSeason.fee_uniform || 35;
      const feeMonthly = selectedSeason.fee_monthly || 50;
      const perPlayer = feeReg + feeUniform + (feeMonthly * 3);
      const total = perPlayer * createdPlayers.length;

      const paymentBreakdown = document.getElementById('payment-breakdown');
      paymentBreakdown.innerHTML = `
        <div class="flex justify-between">
          <span class="text-gray-400">Registration Fee</span>
          <span>$${feeReg} x ${createdPlayers.length}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-400">Uniform Fee</span>
          <span>$${feeUniform} x ${createdPlayers.length}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-400">Monthly Fees (3 months)</span>
          <span>$${feeMonthly * 3} x ${createdPlayers.length}</span>
        </div>
        ${createdPlayers.length > 1 ? `
          <div class="flex justify-between text-sm">
            <span class="text-gray-400">Per player</span>
            <span>$${perPlayer}</span>
          </div>
        ` : ''}
        <div class="border-t border-border pt-3 flex justify-between font-bold">
          <span>Total</span>
          <span class="text-gold">$${total}</span>
        </div>
      `;

      document.getElementById('form-container').classList.add('hidden');
      document.getElementById('success').classList.remove('hidden');
      window.scrollTo(0, 0);
    }

    // Toggle player account options visibility
    function togglePlayerAccountOptions() {
      const checkbox = document.getElementById('create_player_accounts');
      const options = document.getElementById('player-account-options');
      if (checkbox.checked) {
        options.classList.remove('hidden');
      } else {
        options.classList.add('hidden');
      }
    }

    // Skip account creation
    function skipAccountCreation() {
      document.getElementById('account-creation-section').classList.add('hidden');
    }

    // Create account
    async function createAccount() {
      const email = window.registrationEmail;
      const password = document.getElementById('account_password').value;
      const passwordConfirm = document.getElementById('account_password_confirm').value;
      
      // Validation
      if (!password || password.length < 8) {
        alert('Password must be at least 8 characters.');
        return;
      }
      
      if (password !== passwordConfirm) {
        alert('Passwords do not match.');
        return;
      }
      
      const btn = document.getElementById('create-account-btn');
      btn.disabled = true;
      btn.textContent = 'Creating Account...';
      
      try {
        // Create auth user with Supabase
        const { data: authData, error: authError } = await db.auth.signUp({
          email: email,
          password: password,
          options: {
            data: {
              full_name: document.getElementById('parent_name').value.trim(),
              phone: window.registrationPhone,
              family_id: window.registrationFamilyId,
              role: 'parent'
            }
          }
        });
        
        if (authError) throw authError;
        
        // Create profile record
        const profileData = {
          id: authData.user.id,
          email: email,
          phone: window.registrationPhone,
          full_name: document.getElementById('parent_name').value.trim(),
          family_id: window.registrationFamilyId,
          role: 'parent',
          created_at: new Date().toISOString()
        };
        
        const { error: profileError } = await db.from('profiles').insert(profileData);
        if (profileError) console.warn('Profile creation note:', profileError.message);
        
        // Update family with account linkage
        await db.from('families').update({ 
          account_id: authData.user.id,
          updated_at: new Date().toISOString()
        }).eq('id', window.registrationFamilyId);
        
        // Create player accounts if selected
        const createPlayerAccounts = document.getElementById('create_player_accounts').checked;
        if (createPlayerAccounts) {
          const checkboxes = document.querySelectorAll('.player-account-checkbox:checked');
          for (let i = 0; i < checkboxes.length; i++) {
            const checkbox = checkboxes[i];
            const playerId = checkbox.dataset.playerId;
            const pinInput = document.getElementById(`player_pin_${i}`);
            const pin = pinInput ? pinInput.value : '';
            
            if (pin && pin.length === 4) {
              // Update player with PIN for player account access
              await db.from('players').update({
                player_pin: pin,
                player_account_enabled: true,
                parent_account_id: authData.user.id
              }).eq('id', playerId);
            }
          }
        }
        
        // Show success state
        document.getElementById('account-form').classList.add('hidden');
        document.getElementById('account-created').classList.remove('hidden');
        
      } catch (error) {
        console.error('Account creation error:', error);
        alert('Account creation failed: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Create Account';
      }
    }

    init();
  </script>

</body>
</html>
